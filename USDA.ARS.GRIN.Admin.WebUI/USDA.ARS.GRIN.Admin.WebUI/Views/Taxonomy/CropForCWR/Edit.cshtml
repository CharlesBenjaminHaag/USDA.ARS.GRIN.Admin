@model USDA.ARS.GRIN.Admin.WebUI.ViewModels.Taxonomy.CropForCWRViewModel
@{
    ViewBag.Title = "Edit";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .alert-error {
        padding:10px; 
        margin:5px;
    }
</style>

@if (Model.ID > 0)
{
    <div class="row">
        <div class="col-md-12">
            <div class="callout callout-info" style="vertical-align:middle;">
                @Html.Raw(Model.RevisionHistoryText) 
            </div>
        </div>
    </div>
}

@using (Html.BeginForm("CropForCWREdit", "Taxonomy", FormMethod.Post, new { id = "frmEdit"}))
{
    @Html.HiddenFor(x => x.ID, new { id = "hfCropID", name = "ID" })
    @Html.ValidationSummary()
    @Html.Raw(Model.ErrorMessage)

    <div class="box box-default">
        <div class="box-header">
            <h3 class="box-title">Detail</h3>
            <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse">
                    <i class="fa fa-minus"></i>
                </button>
            </div>
        </div>
        <div class="box-body">
            <div class="row">
                <div class="col-md-12">
                    @*<div id="save-confirmation" class="alert alert-success alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                        <h4><i class="icon fa fa-check"></i> Alert!</h4>
                        <div id="status-holder-DEBUG"></div>
                    </div>*@
                </div>
                <div class="col-md-12">
                    <div id="status-holder"></div>
                    <input type="submit" id="btn-save" class="btn btn-success pull-right" style="margin-right:5px;" value="Save Edits" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="form-horizontal">
                        <div class="box-body">
                            @if (Model.ID > 0)
                            {
                                <div class="form-group my-auto">
                                    <label for="txtGenus" class="col-sm-2 control-label">ID</label>
                                    <div class="col-sm-10">
                                        <input type="text" id="txtSpeciesID" disabled="" value="@Model.ID" class="form-control" />
                                    </div>
                                </div>
                            }
                            <div class="form-group">
                                <label for="txtName" class="col-sm-2 control-label">Crop Name</label>
                                <div class="col-sm-10">
                                    @Html.TextBoxFor(x => x.CropName, new { @id = "txtCropName", @class = "form-control" })
                                    @Html.ValidationMessageFor(x => x.CropName, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="txtNote" class="col-sm-2 control-label">Note</label>
                                <div class="col-sm-10">
                                    @Html.TextAreaFor(x => x.Note, new { @id = "txtNote", @class = "form-control" })
                                    <button type="button" class="btn btn-default btn-flat pull-right" style="margin-top:10px;" data-toggle="modal" data-target="#modal-note-search">Search Notes...</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (Model.ID > 0)
{
    <div class="box box-default">
        <div class="box-header">
            <h3 class="box-title">CWR Maps</h3>
            <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse">
                    <i class="fa fa-minus"></i>
                </button>
            </div>
        </div>
        <div id="section-crop-map-list" class="box-body">
            <div class="row">
                <div class="col-md-12">
                    @{Html.RenderAction("CWRMapList", "Taxonomy", new { cropId = Model.ID });}
                </div>
            </div>
        </div>
    </div>
}


<!--
=====================================================================================
MODALS
=====================================================================================
-->
<div class="modal fade" id="modal-note-search">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Note Search</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="input-group">
                            <input type="text" id="txtSearchNotes" class="form-control">
                            <span class="input-group-btn">
                                <button type="button" id="btnSearchNotes" class="btn btn-info btn-flat">Search</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div id="section-note-search-results">

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger pull-right" data-dismiss="modal">Close</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

<script type="text/javascript">

    // Wait for document to load 
    //$(document).ready(() => {
    //    $('.info').on('submit', () => {

    //        // prevents default behaviour 
    //        // Prevents event propagation 
    //        return false;
    //    });
    //});
    //$('.info').keypress((e) => {

    //    // Enter key corresponds to number 13 
    //    if (e.which === 13) {
    //        $('#frmEdit').submit();
    //        console.log('form submitted');
    //    }
    //}) 


//$(document).ready(function () {
//    var timeoutId;

//    $('form input, form textarea').on('input propertychange change', function () {
//        console.log('Textarea Change');

//        clearTimeout(timeoutId);
//        timeoutId = setTimeout(function () {
//            // Runs 1 second (1000 ms) after the last change
//            saveToDB();
//        }, 1000);
//    });

//    function saveToDB() {
//        console.log('Saving to the db');
//        //$('#status-holder').html('<span class=label label-default>SAVING CHANGES...</span>');
//        $("#frmEdit").submit();
//    }
//});

function SelectNote(noteText) {
            $('#modal-note-search').modal('hide');
            $("#txtNote").val(noteText);
        }

$("#btnSearchNotes").click(function () {
            var noteContext = "taxonomy_cwr_crop";
            var url = "/Taxonomy/FindNotes/";
            var inputSearchString = $("#txtSearchNotes").val();

            $.post(url, { searchString: inputSearchString, context: noteContext })
                .done(function (response) {
                    $("#section-note-search-results").html(response);
                });
        });

$(document).on("click", "[id*='btnDeleteMultiple']", function(){
            var valueArray = [];
            var url = "";
            var inputCropId = 0;

            inputCropId = $("#hfCropID").val();

            $("#section-crop-map-list input:checked").each(function () {
                var id = $(this).attr("id");
                valueArray.push(id);
                }
            );

           url = '@Url.Action("CropMapsDelete", "Taxonomy")';

            $.get(url, { cropId: inputCropId, cropMapIdList: valueArray.toString() })
                .done(function (response) {
                    $("#section-crop-map-list").html(response);
            });
        });

</script>
